// SECURITY AUDIT CHANGES
// Layer 2: Strict Row-Level Security (RLS) in Firestore Rules
// - All users can only access their own data
// - System settings are ADMIN-ONLY (fixes critical vulnerability)
// - All other collections protected with document-level ownership checks
// - Default DENY ALL for unlisted collections
// Generated: 2025-12-25
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper for admin check
    function isAdmin() {
      return request.auth != null && (
        request.auth.token.email == 'sami8051@gmail.com' ||
        request.auth.token.email == 'testadmin@example.com' ||
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true)
      );
    }

    // Helper for approved status check
    function isApproved() {
      return request.auth != null && (
        isAdmin() || 
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.status == 'approved' ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isApproved == true
        ))
      );
    }
    
    // =====================================================
    // LAYER 1: ROW-LEVEL SECURITY (RLS)
    // =====================================================
    
    // === EXAM RESULTS: User can only access their own ===
    match /examResults/{resultId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      // RLS: Read/Update/Delete ONLY own documents
      allow read, update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      // Admin can access all
      allow read, update, delete: if isAdmin();
    }

    // === USERS: User can only read/write their own profile ===
    match /users/{userId} {
      // RLS: Can only read own document
      allow read: if request.auth != null && request.auth.uid == userId;
      // Admin can read all
      allow read: if isAdmin();
      
      // RLS: Can only write own document
      allow write: if request.auth != null && request.auth.uid == userId && 
        // Users CANNOT modify critical fields (except during initial signup)
        (
           // If creating new doc - allow setting initial status to 'pending' and isApproved to false
           (!exists(/databases/$(database)/documents/users/$(userId)) && 
            !request.resource.data.keys().hasAny(['isAdmin', 'disabled']) &&
            // Only allow safe initial values
            (!request.resource.data.keys().hasAny(['status']) || request.resource.data.status == 'pending') &&
            (!request.resource.data.keys().hasAny(['isApproved']) || request.resource.data.isApproved == false)
           ) ||
           // If updating existing doc - cannot modify protected fields at all
           (exists(/databases/$(database)/documents/users/$(userId)) && 
            !request.resource.data.diff(resource.data).affectedKeys().hasAny(['isAdmin', 'isApproved', 'status', 'disabled'])
           )
        );
      // Admin can write all fields
      allow write: if isAdmin();
    }

    // === USER CONSENTS: User can only access their own ===
    match /userConsents/{userId} {
       // RLS: User can CREATE and READ own consent parent doc
       allow create: if request.auth != null && request.auth.uid == userId;
       allow read: if request.auth != null && request.auth.uid == userId;
       // Admin can access all
       allow read, write: if isAdmin();
    }
    
    match /userConsents/{userId}/events/{eventId} {
       // RLS: User can only create/read own consent events
       allow create: if request.auth != null && request.auth.uid == userId;
       allow read: if request.auth != null && request.auth.uid == userId;
       // Admin can access all
       allow read, write: if isAdmin();
    }

    // === LAB SESSIONS: User can only access their own ===
    match /labSessions/{sessionId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      // RLS: Read/Update/Delete ONLY own documents
      allow read, update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      // Admin can access all
      allow read, update, delete: if isAdmin();
    }

    // =====================================================
    // SYSTEM SETTINGS: ADMIN ONLY (except API key for server)
    // =====================================================
    
    // CRITICAL: API Keys and system config
    // Server needs to read geminiApiKey without authentication
    match /systemSettings/config {
      // Allow server (no auth) to read ONLY for initialization
      // Admins can read everything
      allow read: if request.auth == null || isAdmin();
      // DENY all writes except admin
      allow write: if isAdmin();
    }
    
    match /systemSettings/{document} {
      // DENY all reads except admin (was: if request.auth != null - FIXED)
      allow read: if isAdmin();
      // DENY all writes except admin
      allow write: if isAdmin();
    }

    // =====================================================
    // ANNOUNCEMENTS: Authenticated users can read
    // =====================================================
    match /announcements/{announcementId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // =====================================================
    // AUDIT LOGS: ADMIN ONLY
    // =====================================================
    match /activityLogs/{logId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    match /loginEvents/{eventId} {
      allow read: if isAdmin();
      // Users can log their own login events
      allow write: if request.auth != null;
    }

    // =====================================================
    // CLASSROOM RULES: Teacher-Student RLS
    // =====================================================
    match /classes/{classId} {
      // Only teachers (admins) can create their own classes
      allow create: if isAdmin() && request.resource.data.teacherId == request.auth.uid;
      // Teachers can update/delete their own classes
      allow update, delete: if isAdmin() && resource.data.teacherId == request.auth.uid;
      
      // Approved users can read classes they're members of
      allow read: if isApproved() && request.auth != null;
      
      // Members subcollection
      match /members/{memberId} {
        allow read: if request.auth != null;
        // RLS: User can only add themselves if approved
        allow create: if request.auth != null && request.auth.uid == memberId && isApproved(); 
        // Only class owner or admin can remove members
        allow delete: if isAdmin() || 
          (isApproved() && exists(/databases/$(database)/documents/classes/$(classId)) &&
           get(/databases/$(database)/documents/classes/$(classId)).data.teacherId == request.auth.uid);
      }
    }

    // =====================================================
    // ASSIGNMENTS: RLS for Teacher-Student Access
    // =====================================================
    match /assignments/{assignmentId} {
      // Only teachers can create assignments
      allow create: if isAdmin() && request.resource.data.teacherId == request.auth.uid;
      // Only assignment creator can update/delete
      allow update, delete: if isAdmin() && resource.data.teacherId == request.auth.uid;
      // Approved users can read
      allow read: if isApproved();
    }

    // === ASSIGNMENT RESULTS: RLS for Student/Teacher Access ===
    match /assignment_results/{resultId} {
      // Student can create their own results
      allow create: if request.auth != null && request.resource.data.studentId == request.auth.uid && isApproved();
      // Student can read their own, teacher can read student results
      allow read: if request.auth != null && (
        resource.data.studentId == request.auth.uid ||
        isAdmin()
      ); 
      // Student can update their own, admin can update any
      allow update: if request.auth != null && (
        (resource.data.studentId == request.auth.uid && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['gradedBy', 'finalScore'])) ||
        isAdmin()
      );
    }

    // =====================================================
    // DENY ALL by default
    // =====================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
